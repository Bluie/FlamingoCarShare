{% load static %}
{% load static %}
<div id="map"></div>

<script>
    var map, infoWindow;

    function initMap() {
        var options = {
            zoom: 14,
            center: {lat:-37.8136, lng:144.9631}
        }

        // New map //
        var map = new google.maps.Map(document.getElementById('map'), options);
        var infoWindow = new google.maps.InfoWindow();

        // User icon //
        var uimage = {
            url: '{% static 'img/usericon.png' %}',
            scaledSize: new google.maps.Size(25, 32)
        };
        umarker = new google.maps.Marker({
            map: map,
            icon: uimage,
        });


        // Try HTML5 geolocation //
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                infoWindow.setPosition(pos);
                infoWindow.setContent('You are here');
                infoWindow.open(map, umarker);
                umarker.setPosition(pos);
                map.setCenter(pos);
                },
                function() {
                    handleLocationError(true, infoWindow, map.getCenter());
                }
            );
        }

        // Browser doesn't support Geolocation //
        else {
            handleLocationError(false, infoWindow, map.getCenter());
        }

        // Car locations //
        {% for cars in Cars %}
        var car{{ cars.car_id }} = {
            lat: {{ cars.lat }},
            lng: {{ cars.lng }}
        };
        {% endfor %}

        // Marker icons //
        var imagecar1 = '{% static 'img/eco2icon.png' %}'
        var imagecar2 = '{% static 'img/lux2icon.png' %}'
        var imagecar3 = '{% static 'img/suv2icon.png' %}'

        // Car markers //
        {% for cars in Cars %}
        var markerc{{ cars.car_id }} = new google.maps.Marker({
            position: car{{ cars.car_id }},
            map: map,
            icon: imagecar{{ cars.icon }},
            //zIndex: google.maps.Marker.MAX_ZINDEX + 1
        });
        {% endfor %}

        // sidepanel input //
        {% for cars in Cars %}
        var content{{ cars.car_id }} = '\
          <div id="viewcar" style="display:block;">\
            <h1 class="col text-center">{{ cars.car_name }}</h1>\
            <p>\
              {{ cars.description }}\
              <br>\
              Price per day: {{ cars.price }}\
              <br><br><br>\
              <button class="btn btn-danger" onclick="Swap()">Book this car</button>\
            </p>\
          </div>\
          <div id="bookcar" style="display:none;">\
            <h1 class="col text-center">Book</h1>\
              <form method="post">\
                {% csrf_token %}\
                <p class="col text-center" style="color:hotpink;"">{{ cars.car_name }}</p>\
                <br>\
                <select style="color:hotpink; display:none;" disabled required name="car" id="id_car">\
                  <option selected value="{{ cars.car_id }}">{{ cars.car_name }}</option>\
                </select>\
                <p><label for="id_book_start_date">Book date:</label></p>\
                <p><input type="date" name="book_start_date" id="id_book_start_date"></p>\
                <br>\
                <p><label for="id_start_time">Book time:</label></p>\
                <p><input type="time" name="start_time" id="id_start_time"></p>\
                <br>\
                <button type="submit" class="btn btn-danger">Book</button>\
              </form>\
            <p>UNDER CONSTRUCTION</p>\
          </div>\
          ';

        // markers change sidepanel //
        google.maps.event.addListener(markerc{{ cars.car_id }}, 'click', function() {
            document.getElementById("sidepanel").innerHTML = content{{ cars.car_id }};
        });
        {% endfor %}
    }

    // sidepanel DIV change //
    function Swap() {
      d1 = document.getElementById('viewcar');
      d2 = document.getElementById('bookcar');
      if( d2.style.display == "none" ) {
        d1.style.display = "none";
        d2.style.display = "block";
      }
      else {
        d1.style.display = "block";
        d2.style.display = "none";
      }
    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
            'Error: The Geolocation service failed.' :
            'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);
    }
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?v=quarterly&key=AIzaSyCFqINDKm7Oa0_ldIEICdxDzDaMH6Ha-_8&callback=initMap"></script>
